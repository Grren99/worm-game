# WebAudio 믹서 리팩터링 개요 및 테스트 플랜

## 구조 개요
- **마스터 버스** → 모든 사운드의 최종 출력. 기본 게인은 0.9.
- **SFX 버스** → 게임플레이/파워업/관전자/알림 음향을 묶는 상위 버스. UI 슬라이더가 제어.
- **UI 버스** → 시스템 알림/채팅/설정 액션 음향.
- **Gameplay 버스** → 음식, 사망, 라운드 시작/종료 등 전투 피드백.
- **Powerup 버스** → 파워업 발동/지속/종료 효과음. Gameplay 버스 하위에 위치.
- **Spectator 버스** → 관전자 HUD 전환/잠금 전용. UI 버스 하위에 위치.
- **BGM 버스** → 배경음. 마스터에 직접 연결되어 SFX 슬라이더 영향 없음.

## 리팩터링 포인트
- 버스 생성/조회 유틸 (`createBus`, `getBus`) 추가로 후속 카테고리 확장이 쉬움.
- 파워업 루프 음향 관리(`startEffectLoop`, `stopEffectLoop`, `stopAllEffectLoops`)로 지속/해제 사운드 통합.
- `playSequence` 헬퍼로 짧은 톤 시퀀스를 선언형으로 구성.
- `syncActiveEffectLoops` 가 오디오 재활성화 시 현재 버프 상태를 재생성.

## 수동 테스트 체크리스트
1. **오디오 활성화/비활성화**
   - 슬라이더 변경 후 재접속 시 기존 값 유지 확인.
   - 비활성화 시 모든 루프/배경음이 즉시 종료.
2. **일반 게임플레이**
   - 음식 섭취, 사망, 라운드 시작/종료가 Gameplay 버스를 통해 출력.
   - 관전자 전환/잠금 시 Spectator 버스가 정상 작동 (UI 슬라이더에 반응).
3. **파워업 루프**
   - 속도/무적/축소 파워업 획득 시 고유 시퀀스 + 루프가 재생.
   - 파워업 종료 시 잔향 시퀀스가 한 번만 재생되고 루프가 완전히 멈춤.
   - 게임 중 오디오 토글 → 재활성화 후에도 현재 버프의 루프가 재생.
4. **리플레이/관전**
   - 관전자 상태에서 타 플레이어의 파워업은 원거리 게인(약 60%)으로만 재생.
   - 로컬 플레이어만 지속 루프가 들리는지 확인.
5. **성능/리소스**
   - 여러 파워업이 연속으로 발동해도 오실레이터가 누수 없이 종료.
   - 콘솔에 WebAudio 관련 경고가 남지 않는지 확인.

## 자동화 아이디어
- Jest + jsdom 환경에 WebAudio를 모킹해 버스 생성 및 루프 상태를 스냅샷 테스트.
- Playwright 기반 e2e에서 가상 슬라이더 조작 후 `AudioContext` 의 게인값 검증.
